---
title: "Create a bar plot showing frequencies of dservice disruptions in California (2019)"
author: "Shenyue Jia"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width = 8.5)
knitr::opts_chunk$set(fig.height = 6.5)
knitr::opts_chunk$set(fig.align = 'center')
```


## Library Set up

```{r, results='hide', error=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(zoo)
library(foreign)
library(here)
library(purrr)
library(lubridate)
library(ggthemes)
library(viridis)
library(classInt)
library(hrbrthemes)
library(ggridges)
```

## Read California state-level aggregated data showing power outages

Get county-level power outage counts
```{r warning=FALSE, message=FALSE}
rm(list = ls())

county_outage_df <- read_csv(here("data_private","ca_geography",
                                  "ca_pct_household_oop_new_def.csv"))

```


Add a Month column
```{r message=FALSE, warning=FALSE}

county_outage_df <- county_outage_df %>%
    # filter(Duration>=60) %>%
    mutate(Month = factor(month(Start,label = TRUE)))

```


## What is the overall distribution of outages?

Plot all disruptions > 60 min
```{r message=FALSE, warning=FALSE}
county_outage_df %>%
  filter(Duration >= 60) %>%
  ggplot(aes(x=Duration))+
  geom_histogram(alpha = 0.3,
                 color="grey20",
                 size=0.4,
                 binwidth = 60)+
  scale_x_continuous(breaks = c(60,60*8,60*16,60*24),
                     labels = c("1-8 hrs","9-16 hrs","17-24 hrs","24+ hrs"),
                     minor_breaks = NULL) +
  # scale_y_continuous(trans = "log")+
  theme_ipsum() +
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 12,face = "bold")
    )+
  ggtitle("a) All disruptions in 2019")+
  labs(x="Duration (bin size = 1 hr)",y="log(Count of disruptions)")->p1
  
p1

```


Create a data frame that contains a type field for disruptions based on duration

```{r message=FALSE, warning=FALSE}
# library(lemon)
# library(ggridges)
df_plot <- bind_rows(
                    county_outage_df %>%
                      filter(Duration >=60 & Duration<=8*60) %>%
                      mutate(Type = "1-8 hrs"),
                    county_outage_df %>%
                      filter(Duration >8*60 & Duration<=16*60) %>%
                      mutate(Type = "9-16 hrs"),
                    county_outage_df %>%
                      filter(Duration >16*60 & Duration<=24*60) %>%
                      mutate(Type = "17-24 hrs"),
                    county_outage_df %>%
                      filter(Duration >24*60) %>%
                      mutate(Type = "24+ hrs"))
df_plot$Type <- as.factor(df_plot$Type)

#levels(df_plot$Type) <- c("a) Disruption Duration >= 1 hr",
#                     "b) Disruption Duration >= 24 hrs","c) Disruption Duration >= 3 days")
```



Calculate state-level customer-minutes (or customer-hours)
```{r message=FALSE, warning=FALSE}

df_plot_state_agg <- df_plot %>%
  mutate(customer_hours = round(SegCustomerMinutes/60,0)) %>%
  group_by(Month,Type) %>%
  summarise(count = n(),
            sum_customers_minutes = sum(SegCustomerMinutes),
            sum_customers_hours = sum(customer_hours)) %>%
  complete(Month,Type,fill=list(count=NA,
                                sum_customers_minutes=NA,
                                sum_customers_hours=NA))

df_plot_state_agg$Type <- factor(df_plot_state_agg$Type,
                                 levels=c("1-8 hrs","9-16 hrs","17-24 hrs","24+ hrs"))

```


## Plot customer-hours by month

Without log10 transform for Y axis
```{r message=FALSE, warning=FALSE}


df_plot_state_agg %>%
  ggplot(aes(x = Month,y=sum_customers_hours,
             fill=Type,group=Type)) +
  geom_col(position = "dodge")+
  # geom_text(aes(label = label,group=Type),
  #           position = position_dodge(width = .9),
  #           vjust = -0.5,
  #           size = 2.5,colour = "grey20")+
  scale_fill_manual(values=c("#CABED0", "#BC7C8F", "#AE3A4E","#330000"))+
  scale_y_continuous(trans = "log10",
                     breaks = c(1000000,1000000000,100000000000),
                     labels = c("0.01","1","100"))+
  guides(fill=guide_legend(title=element_blank()))+
  # facet_wrap(~Type,ncol =1)+
  theme_ipsum() +
    theme(
      legend.position="bottom",
      panel.spacing = unit(0.1, "lines"),
      axis.title.x = element_blank()
    )+
  labs(y="Customer-hours in billions") -> p2
p2
```

Without log10 transform for Y axis
```{r message=FALSE, warning=FALSE}
df_plot_state_agg %>%
  ggplot(aes(x = Month,y=sum_customers_hours/1000000000,
             fill=Type,group=Type)) +
  geom_col(position = "dodge")+
  # geom_text(aes(label = label,group=Type),
  #           position = position_dodge(width = .9),
  #           vjust = -0.5,
  #           size = 2.5,colour = "grey20")+
  scale_fill_manual(values=c("#CABED0", "#BC7C8F", "#AE3A4E","#330000"))+
  # scale_y_continuous(trans = "log10",
  #                    breaks = c(1000000,1000000000,100000000000),
  #                    labels = c("0.01","1","100"))+
  guides(fill=guide_legend(title=element_blank()))+
  # facet_wrap(~Type,ncol =1)+
  theme_ipsum() +
    theme(
      legend.position="bottom",
      panel.spacing = unit(c(0,0,0,0), "mm"),
      plot.margin = unit(c(0,0,0,0), "mm"),
      axis.title.x = element_blank()
    )+
  labs(y="Customer-hours (billions)") -> p21
p21
```

Without log10 transform for Y axis, no Y axis labels
```{r message=FALSE, warning=FALSE}
df_plot_state_agg %>%
  # mutate(label = round(sum_customers_hours,2)) %>%
  ggplot(aes(x = Month,y=sum_customers_hours,
             fill=Type,group=Type)) +
  geom_col(position = "dodge")+
  # geom_text(aes(label = label,group=Type),
  #           position = position_dodge(width = .9),
  #           vjust = -0.5,
  #           size = 2.5,colour = "grey20")+
  scale_fill_manual(values=c("#CABED0", "#BC7C8F", "#AE3A4E","#330000"))+
  scale_y_continuous(trans = "log",
                     breaks = c(1000000,1000000000,100000000000),
                     labels = c("0.01","1","100"))+
  guides(fill=guide_legend(title=element_blank()))+
  # facet_wrap(~Type,ncol =1)+
  # theme_ipsum() +
  theme_bw()+
    theme(
      legend.position="bottom",
            panel.spacing = unit(c(0,0,0,0), "mm"),
      plot.margin = unit(c(0,0,0,0), "mm"),
      axis.title.x = element_blank()
    )+
  labs(y="log(Customer-hours in billions)") -> p22
p22
```


## Plot major disruptions in bar plot

```{r message=FALSE, warning=FALSE}

df_plot$Type <- factor(df_plot$Type,
                                 levels=c("1-8 hrs","9-16 hrs","17-24 hrs","24+ hrs"))

# extrafont::loadfonts()
df_plot_count <- df_plot %>%
  group_by(Month,Type) %>%
  summarise(Count = n()) %>%
  complete(Month,Type,fill=list(Count=0)) %>%
  mutate(label = ifelse(Count==0,NA,Count)) %>%
  ggplot(aes(x = Month,y=Count,fill=Type,group=Type)) +
  geom_col(position = "dodge")+
  geom_text(aes(label = label,group=Type),
            position = position_dodge(width = .9),
            vjust = -0.5,
            size = 2.5,colour = "grey20")+
  scale_fill_manual(values=c("#CABED0", "#BC7C8F", "#AE3A4E","#330000"))+
  scale_x_discrete(breaks = c("Jan","Feb","Mar","Apr","May","Jun","Jul",
                              "Aug","Sep","Oct","Nov","Dec"),
                   labels = c("Jan","Feb","Mar","Apr","May","Jun","Jul",
                              "Aug","Sep","Oct","Nov","Dec 2019"))+
  scale_y_continuous(limits = c(0,300))+
  guides(fill=guide_legend(title=element_blank()))+
  # facet_wrap(~Type,ncol =1)+
  # theme_ipsum() +
  theme_bw()+
    theme(
      legend.position="bottom",
      panel.spacing = unit(c(0,0,0,0), "mm"),
      plot.margin = unit(c(0,0,0,0), "mm"),
      axis.title.x = element_blank(),
      axis.text.y = element_blank()
    )+
  # ggtitle("b) Major, severe, and extreme disruptions by starting months")+
  labs(y="Monthly Frequency of power disruptions") -> p3
p3
```


```{r message=FALSE, warning=FALSE}

df_plot$Type <- factor(df_plot$Type,
                                 levels=c("1-8 hrs","9-16 hrs","17-24 hrs","24+ hrs"))

# extrafont::loadfonts()
df_plot_count <- df_plot %>%
  group_by(Month,Type) %>%
  summarise(Count = n()) %>%
  complete(Month,Type,fill=list(Count=0)) %>%
  mutate(label = ifelse(Count==0,NA,Count))

df_plot_count_first <- df_plot_count %>%
  group_by(Month, Type) %>%
  summarise(Month = first(Month),
            Type = first(Type),
            Count = first(Count),
            label = first(label))
```

## Plot major disruptions in bar plot

```{r message=FALSE, warning=FALSE}

extrafont::loadfonts()
df_plot_count_first %>%
  # ggplot(aes(x = Month,y=Count,fill=Type,group=Type)) +
  ggplot(aes(x = Month,y=Count,fill=Type)) +
  geom_col(position = "dodge")+
  geom_text(aes(label = label,group=Type),
            position = position_dodge(width = .9),
            vjust = -0.5,
            size = 2.5,colour = "grey20")+
  scale_fill_manual(values=c("#CABED0", "#BC7C8F", "#AE3A4E","#330000"))+
  scale_x_discrete(breaks = c("Jan","Feb","Mar","Apr","May","Jun","Jul",
                              "Aug","Sep","Oct","Nov","Dec"),
                   labels = c("Jan","Feb","Mar","Apr","May","Jun","Jul",
                              "Aug","Sep","Oct","Nov","Dec 2019"))+
  # scale_y_continuous(labels = c(0,25,50,75,100))+
  scale_y_continuous(labels=function(x) format(x, big.mark = ".", scientific = FALSE))+
  guides(fill=guide_legend(title=element_blank()))+
  # facet_wrap(~Type,ncol =1)+
  # theme_ipsum() +
  theme_bw()+
    theme(
      legend.position="bottom",
      panel.spacing = unit(c(0,0,0,0), "mm"),
      plot.margin = unit(c(0,0,0,0), "mm"),
      axis.title.x = element_blank()
    )+
  # ggtitle("b) Major, severe, and extreme disruptions by starting months")+
  labs(y="Monthly Frequency of power disruptions") -> p31
p31


```

## Plot major disruptions in bar plot withs stacked bar

```{r message=FALSE, warning=FALSE}

df_plot_count_first %>%
  # ggplot(aes(x = Month,y=Count,fill=Type,group=Type)) +
  ggplot(aes(x = Month,y=Count,fill=Type)) +
  geom_col(position = position_stack(),width=0.5)+
  # geom_text(aes(label = label,group=Type),
  #           position = position_dodge(width = .9),
  #           vjust = -0.5,
  #           size = 2.5,colour = "grey20")+
  scale_fill_manual(values=c("#CABED0", "#BC7C8F", "#AE3A4E","#330000"))+
  scale_x_discrete(breaks = c("Jan","Feb","Mar","Apr","May","Jun","Jul",
                              "Aug","Sep","Oct","Nov","Dec"),
                   labels = c("Jan","Feb","Mar","Apr","May","Jun","Jul",
                              "Aug","Sep","Oct","Nov","Dec 2019"))+
  # scale_y_continuous(labels = c(0,25,50,75,100))+
  scale_y_continuous(labels=function(x) format(x, big.mark = ".", scientific = FALSE))+
  guides(fill=guide_legend(title=element_blank()))+
  # facet_wrap(~Type,ncol =1)+
  # theme_ipsum() +
  theme_bw()+
    theme(
      legend.position="bottom",
      panel.spacing = unit(c(0,0,0,0), "mm"),
      plot.margin = unit(c(0,0,0,0), "mm"),
      axis.title.x = element_blank()
    )+
  # ggtitle("b) Major, severe, and extreme disruptions by starting months")+
  labs(y="Monthly Frequency of power disruptions") -> p3
p3
```



Save to a PNG file
```{r}
# source(here("code","multiplot.R"))
# png(file = here("health_affairs_plots","plot","02_bar_figure_disruptions_by_month.png"),
# width = 1500, height = 1200,res = 150)
# # multiplot(p1, p7, cols=1)
library(patchwork)
layout <- "
A
B"
# p1 + p2 + plot_layout(design = layout)
# 
# 
# dev.off()

p_all <- p3+p21 + plot_layout(design = layout)
# dev.off()


ggsave(
  here("health_affairs_plots","plot","04_barplot_outage_count_notrans_stacked.pdf"),
  p3,
  # device = cairo_pdf,
  width = 6,
  height = 3,
  scale = 1
)

ggsave(
  here("health_affairs_plots","plot","04_barplot_outage_count_notrans_stacked.png"),
  p3,
  # device = cairo_pdf,
  width = 6,
  height = 3,
  scale = 1
)

ggsave(
  here("health_affairs_plots","plot","03_barplot_outage_count_notrans_dodge.pdf"),
  p31,
  # device = cairo_pdf,
  width = 8,
  height = 4,
  scale = 1
)

ggsave(
  here("health_affairs_plots","plot","04_barplot_outage_count.png"),
  p3,
  # device = cairo_pdf,
  width = 8,
  height = 4,
  scale = 1
)

p_customer_hours <- p21+p22 + plot_layout(design = layout)
# dev.off()
ggsave(
  here("health_affairs_plots","plot","02_barplot_customer_hours.png"),
  p_customer_hours,
  # device = cairo_pdf,
  width = 8,
  height = 6,
  scale = 0.9
)


# p_all_notrans_noYlab <- p3+p22 + plot_layout(design = layout)
# # dev.off()
# ggsave(
#   here("health_affairs_plots","plot","02_barplot_notrans_noYlab.png"),
#   p_all_notrans_noYlab,
#   # device = cairo_pdf,
#   width = 8,
#   height = 6,
#   scale = 0.9
# )

```