---
title: "Create Figure 1 customer experiencing an power outage in California (2019)"
author: "Shenyue Jia"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width = 8.5)
knitr::opts_chunk$set(fig.height = 6.5)
knitr::opts_chunk$set(fig.align = 'center')
```


## Library Set up

```{r, results='hide', error=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(zoo)
library(foreign)
library(here)
library(purrr)
library(lubridate)
library(ggthemes)
library(viridis)
library(classInt)
library(bayestestR)
```

## Import CSV file for county-level population

Read county-level demographics metrics. Total number of housing units will be 
used as the denominator to calculate OOP customers % out of all housing units.
```{r}
rm(list = ls())
if(any(grepl("package:plyr", search()))) detach("package:plyr",unload = TRUE) else message("plyr not loaded")

total_pop <- read.csv(here(
    # dir,
    "data_private","ca_geography",
                           "california_county_demographics.csv"))
# total_pop %>% DT::datatable(rownames = FALSE)
total_hh <- total_pop %>% select(NAME,TOTPOP_CY,TOTHH_CY,TOTHU_CY)
```


## Read the long form data for all counties

Get long form data for all counties in California
Aggregate the data to day level by obtaining the max
value of customers experiencing an outage during the same day

Aggregate the daily data to the state level by calculating
the sum of all customers experiencing an outage during the same day
over entire California

Test if the pct of customers out of power can be correctly calculated
```{r message=FALSE, warning=FALSE}
csv_files <- fs::dir_ls(here("data_private","long_form_missing_flg_fixed_county"), 
                        regexp = "\\.csv$")
nfiles <- length(csv_files)

```

# Calculate other key metrics of power outage
Calculate pct customers affected (denominator = Total housing units)
Calculate CustomerMinutes = CustomersOut of current 10-min interval * 10 min
If a total customer-minutes out of power is needed, just add all rows.
```{r message=FALSE, warning=FALSE}

for (i in 1:nfiles){
  
  curr_df <- csv_files[i] %>% 
      map_dfr(read_csv) %>%
      # mutate(date_fmt = ymd_hms(date)) %>%
      # group_by(CountyName,date) %>%
      # summarise(CustomersOutTimeSum = sum(CustomersOut,na.rm = TRUE)) %>%
      mutate(PctCustomerOut = (CustomersOut/total_hh$TOTHU_CY[i])*100,
             PctCustomerOut = ifelse(PctCustomerOut>100,100,PctCustomerOut),
             CustomerMinutes = CustomersOut*10,
             TotalHU = total_hh$TOTHU_CY[i],
             CustomerThres = round(TotalHU*0.005,0))
  

  if (i == 1){
    ca_big_df <- curr_df
  }else{
    ca_big_df <- bind_rows(ca_big_df, curr_df)
  }

}
  



```


# Aggregate data to state level
```{r}
ca_agg_state <- ca_big_df %>%
  group_by(date) %>%
  summarise(CustomersOutState = sum(CustomersOut,na.rm = TRUE),
         CustomerMinutesState = sum(CustomerMinutes,na.rm = TRUE),
         TotalHUState = sum(TotalHU,na.rm = TRUE)) %>%
  mutate(PctCustomerOutState = CustomersOutState/TotalHUState*100)
```

Save the ca_big_df data frame to RDS
```{r}
saveRDS(ca_big_df, file = here("data_private","ca_geography",
  "ca_outage_customers_by_county_2019_10min.RDS"))

saveRDS(ca_agg_state, file = here("data_private","ca_geography",
  "ca_outage_customers_state_2019_10min.RDS"))
```
